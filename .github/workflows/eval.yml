name: Baseline Eval
on:
  push:
    paths:
      - "temp_logger.py"
      - "data/**"
      - "eval/**"
  schedule:
    - cron: "20 3 * * *"   # daily at 03:20 UTC
  workflow_dispatch:

jobs:
  eval:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install pandas scikit-learn matplotlib

      - name: Run baseline
        run: |
          python - <<'PY'
          import pandas as pd, json, pathlib, matplotlib.pyplot as plt
          p = pathlib.Path("data")
          df_list = []
          for f in p.glob("*.csv"):
              try:
                  df_list.append(pd.read_csv(f))
              except Exception:
                  pass
          df = pd.concat(df_list, ignore_index=True) if df_list else pd.DataFrame()
          # Handle both 'temp' and 'temperature_celsius' column names
          temp_col = 'temperature_celsius' if 'temperature_celsius' in df.columns else 'temp'
          if not df.empty and {'timestamp', temp_col} <= set(df.columns):
              df = df.sort_values('timestamp')
              df['lag1'] = df[temp_col].shift(1)
              df = df.dropna()
              from sklearn.linear_model import LinearRegression
              X = df[['lag1']].values
              y = df[temp_col].values
              m = LinearRegression().fit(X, y)
              yhat = m.predict(X)
              mae = float(abs(y - yhat).mean())
              pathlib.Path("reports").mkdir(exist_ok=True)
              with open("reports/metrics.json","w") as f:
                  json.dump({"mae": mae}, f, indent=2)

              # Create improved plot
              fig, ax = plt.subplots(figsize=(14, 7))
              timestamps = df['timestamp'].iloc[-200:].values
              x_indices = range(len(timestamps))

              ax.plot(x_indices, y[-200:], label='Actual Temperature', linewidth=2, alpha=0.8, color='#2E86AB')
              ax.plot(x_indices, yhat[-200:], label='Predicted (Baseline)', linewidth=2, alpha=0.8, color='#F77F00', linestyle='--')

              ax.set_title(f"Temperature: Actual vs Baseline Prediction (MAE: {mae:.2f}°C)", fontsize=14, fontweight='bold')
              ax.set_xlabel("Time", fontsize=12)
              ax.set_ylabel("Temperature (°C)", fontsize=12)
              ax.legend(loc='upper right', fontsize=11)
              ax.grid(True, alpha=0.3, linestyle='-', linewidth=0.5)

              # Set x-ticks to show only every 20th timestamp for readability
              tick_positions = range(0, len(timestamps), 20)
              ax.set_xticks(tick_positions)
              ax.set_xticklabels([timestamps[i] for i in tick_positions], rotation=45, ha='right')

              plt.tight_layout()
              plt.savefig("reports/last200.png", dpi=300, bbox_inches='tight')
          else:
              pathlib.Path("reports").mkdir(exist_ok=True)
              with open("reports/metrics.json","w") as f:
                  json.dump({"note":"no data yet"}, f)
          PY

      - name: Upload eval artifacts
        uses: actions/upload-artifact@v4
        with:
          name: eval-report
          path: reports/

      # Read metrics into an output we can reference in the comment
      - name: Prepare metrics
        id: prep
        run: |
          if [ -f reports/metrics.json ]; then
            METRICS=$(cat reports/metrics.json | tr -d '\n')
            echo "metrics=$METRICS" >> "$GITHUB_OUTPUT"
          else
            echo "metrics={}" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR (only on PRs)
        if: ${{ github.event_name == 'pull_request' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: baseline-eval
          message: |
            **Baseline Eval**
            ```
            ${{ steps.prep.outputs.metrics }}
            ```
            _Plot & files available in run artifacts:_
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
